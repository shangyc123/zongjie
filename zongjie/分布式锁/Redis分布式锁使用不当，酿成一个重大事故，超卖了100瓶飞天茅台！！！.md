## Redisåˆ†å¸ƒå¼é”ä½¿ç”¨ä¸å½“ï¼Œé…¿æˆä¸€ä¸ªé‡å¤§äº‹æ•…ï¼Œè¶…å–äº†100ç“¶é£å¤©èŒ…å°ï¼ï¼ï¼

æµªæ¼«å…ˆç”Ÿ [Javaå›¢é•¿](javascript:void(0);) *3æœˆ28æ—¥*

![Javaå›¢é•¿](http://mmbiz.qpic.cn/mmbiz_png/QCu849YTaIMoIM1alIZzaicLnmYS9cx2uvAUZLraF6I3Ngq4Uchwh5nr7h34T62m78tpicNs5Dbde3luZ7KBUlhg/0?wx_fmt=png)

**Javaå›¢é•¿**

ä¸“æ³¨Javaç›¸å…³æŠ€æœ¯ï¼šSSMã€Springå…¨å®¶æ¡¶ã€å¾®æœåŠ¡ã€MySQLã€MyCatã€é›†ç¾¤ã€åˆ†å¸ƒå¼ã€ä¸­é—´ä»¶ã€Linuxã€ç½‘ç»œã€å¤šçº¿ç¨‹ï¼Œå¶å°”è®²ç‚¹è¿ç»´Jenkinsã€Nexusã€Dockerã€ELKï¼Œå¶å°”åˆ†äº«äº›æŠ€æœ¯å¹²è´§ï¼Œè‡´åŠ›äºJavaå…¨æ ˆå¼€å‘ï¼



å…¬ä¼—å·

æ¥æºï¼šjuejin.cn/post/6854573212831842311

åŸºäºRedisä½¿ç”¨åˆ†å¸ƒå¼é”åœ¨å½“ä»Šå·²ç»ä¸æ˜¯ä»€ä¹ˆæ–°é²œäº‹äº†ã€‚

æœ¬ç¯‡æ–‡ç« ä¸»è¦æ˜¯åŸºäºæˆ‘ä»¬å®é™…é¡¹ç›®ä¸­å› ä¸ºredisåˆ†å¸ƒå¼é”é€ æˆçš„äº‹æ•…åˆ†æåŠè§£å†³æ–¹æ¡ˆã€‚æˆ‘ä»¬é¡¹ç›®ä¸­çš„æŠ¢è´­è®¢å•é‡‡ç”¨çš„æ˜¯åˆ†å¸ƒå¼é”æ¥è§£å†³çš„ï¼Œæœ‰ä¸€æ¬¡ï¼Œè¿è¥åšäº†ä¸€ä¸ªé£å¤©èŒ…å°çš„æŠ¢è´­æ´»åŠ¨ï¼Œåº“å­˜100ç“¶ï¼Œä½†æ˜¯å´è¶…å–äº†100ç“¶ï¼è¦çŸ¥é“ï¼Œè¿™ä¸ªåœ°çƒä¸Šé£å¤©èŒ…å°çš„ç¨€ç¼ºæ€§å•Šï¼ï¼ï¼

äº‹æ•…å®šä¸ºP0çº§é‡å¤§äº‹æ•…...åªèƒ½å¦ç„¶æ¥å—ã€‚æ•´ä¸ªé¡¹ç›®ç»„è¢«æ‰£ç»©æ•ˆäº†~~

äº‹æ•…å‘ç”Ÿåï¼ŒCTOæŒ‡åç‚¹å§“è®©æˆ‘å¸¦å¤´å†²é”‹æ¥å¤„ç†ã€‚å¥½å§ï¼Œå†²~

### äº‹æ•…ç°åœº

ç»è¿‡ä¸€ç•ªäº†è§£åï¼Œå¾—çŸ¥è¿™ä¸ªæŠ¢è´­æ´»åŠ¨æ¥å£ä»¥å‰ä»æ¥æ²¡æœ‰å‡ºç°è¿‡è¿™ç§æƒ…å†µï¼Œä½†æ˜¯è¿™æ¬¡ä¸ºä»€ä¹ˆä¼šè¶…å–å‘¢ï¼Ÿ

åŸå› åœ¨äºï¼šä¹‹å‰çš„æŠ¢è´­å•†å“éƒ½ä¸æ˜¯ä»€ä¹ˆç¨€ç¼ºæ€§å•†å“ï¼Œè€Œè¿™æ¬¡æ´»åŠ¨å±…ç„¶æ˜¯é£å¤©èŒ…å°ï¼Œé€šè¿‡åŸ‹ç‚¹æ•°æ®åˆ†æï¼Œå„é¡¹æ•°æ®åŸºæœ¬éƒ½æ˜¯æˆå€å¢é•¿ï¼Œæ´»åŠ¨çƒ­çƒˆç¨‹åº¦å¯æƒ³è€ŒçŸ¥ï¼è¯ä¸å¤šè¯´ï¼Œç›´æ¥ä¸Šæ ¸å¿ƒä»£ç ï¼Œæœºå¯†éƒ¨åˆ†åšäº†ä¼ªä»£ç å¤„ç†ã€‚ã€‚ã€‚

```
public SeckillActivityRequestVO seckillHandle(SeckillActivityRequestVO request) {
SeckillActivityRequestVO response;
    String key = "key:" + request.getSeckillId;
    try {
        Boolean lockFlag = redisTemplate.opsForValue().setIfAbsent(key, "val", 10, TimeUnit.SECONDS);
        if (lockFlag) {
            // HTTPè¯·æ±‚ç”¨æˆ·æœåŠ¡è¿›è¡Œç”¨æˆ·ç›¸å…³çš„æ ¡éªŒ
            // ç”¨æˆ·æ´»åŠ¨æ ¡éªŒ
            
            // åº“å­˜æ ¡éªŒ
            Object stock = redisTemplate.opsForHash().get(key+":info", "stock");
            assert stock != null;
            if (Integer.parseInt(stock.toString()) <= 0) {
                // ä¸šåŠ¡å¼‚å¸¸
            } else {
                redisTemplate.opsForHash().increment(key+":info", "stock", -1);
                // ç”Ÿæˆè®¢å•
                // å‘å¸ƒè®¢å•åˆ›å»ºæˆåŠŸäº‹ä»¶
                // æ„å»ºå“åº”VO
            }
        }
    } finally {
        // é‡Šæ”¾é”
        stringRedisTemplate.delete("key");
        // æ„å»ºå“åº”VO
    }
    return response;
}
```

ä»¥ä¸Šä»£ç ï¼Œé€šè¿‡åˆ†å¸ƒå¼é”è¿‡æœŸæ—¶é—´æœ‰æ•ˆæœŸ10sæ¥ä¿éšœä¸šåŠ¡é€»è¾‘æœ‰è¶³å¤Ÿçš„æ‰§è¡Œæ—¶é—´ï¼›é‡‡ç”¨try-finallyè¯­å¥å—ä¿è¯é”ä¸€å®šä¼šåŠæ—¶é‡Šæ”¾ã€‚ä¸šåŠ¡ä»£ç å†…éƒ¨ä¹Ÿå¯¹åº“å­˜è¿›è¡Œäº†æ ¡éªŒã€‚çœ‹èµ·æ¥å¾ˆå®‰å…¨å•Š~ åˆ«æ€¥ï¼Œç»§ç»­åˆ†æã€‚ã€‚ã€‚

### äº‹æ•…åŸå› 

é£å¤©èŒ…å°æŠ¢è´­æ´»åŠ¨å¸å¼•äº†å¤§é‡æ–°ç”¨æˆ·ä¸‹è½½æ³¨å†Œæˆ‘ä»¬çš„APPï¼Œå…¶ä¸­ï¼Œä¸ä¹å¾ˆå¤šç¾Šæ¯›å…šï¼Œé‡‡ç”¨ä¸“ä¸šçš„æ‰‹æ®µæ¥æ³¨å†Œæ–°ç”¨æˆ·æ¥è–…ç¾Šæ¯›å’Œåˆ·å•ã€‚å½“ç„¶æˆ‘ä»¬çš„ç”¨æˆ·ç³»ç»Ÿæå‰åšå¥½äº†é˜²å¤‡ï¼Œæ¥å…¥é˜¿é‡Œäº‘äººæœºéªŒè¯ã€ä¸‰è¦ç´ è®¤è¯ä»¥åŠè‡ªç ”çš„é£æ§ç³»ç»Ÿç­‰å„ç§åå…«èˆ¬æ­¦è‰ºï¼ŒæŒ¡ä½äº†å¤§é‡çš„éæ³•ç”¨æˆ·ã€‚æ­¤å¤„ä¸ç¦ç‚¹ä¸ªèµ~ ä½†ä¹Ÿæ­£å› å¦‚æ­¤ï¼Œè®©ç”¨æˆ·æœåŠ¡ä¸€ç›´å¤„äºè¾ƒé«˜çš„è¿è¡Œè´Ÿè½½ä¸­ã€‚

æŠ¢è´­æ´»åŠ¨å¼€å§‹çš„ä¸€ç¬é—´ï¼Œå¤§é‡çš„ç”¨æˆ·æ ¡éªŒè¯·æ±‚æ‰“åˆ°äº†ç”¨æˆ·æœåŠ¡ã€‚å¯¼è‡´ç”¨æˆ·æœåŠ¡ç½‘å…³å‡ºç°äº†çŸ­æš‚çš„å“åº”å»¶è¿Ÿï¼Œæœ‰äº›è¯·æ±‚çš„å“åº”æ—¶é•¿è¶…è¿‡äº†10sï¼Œä½†ç”±äºHTTPè¯·æ±‚çš„å“åº”è¶…æ—¶æˆ‘ä»¬è®¾ç½®çš„æ˜¯30sï¼Œè¿™å°±å¯¼è‡´æ¥å£ä¸€ç›´é˜»å¡åœ¨ç”¨æˆ·æ ¡éªŒé‚£é‡Œï¼Œ10såï¼Œåˆ†å¸ƒå¼é”å·²ç»å¤±æ•ˆäº†ï¼Œæ­¤æ—¶æœ‰æ–°çš„è¯·æ±‚è¿›æ¥æ˜¯å¯ä»¥æ‹¿åˆ°é”çš„ï¼Œä¹Ÿå°±æ˜¯è¯´é”è¢«è¦†ç›–äº†ã€‚è¿™äº›é˜»å¡çš„æ¥å£æ‰§è¡Œå®Œä¹‹åï¼Œåˆä¼šæ‰§è¡Œé‡Šæ”¾é”çš„é€»è¾‘ï¼Œè¿™å°±æŠŠå…¶ä»–çº¿ç¨‹çš„é”é‡Šæ”¾äº†ï¼Œå¯¼è‡´æ–°çš„è¯·æ±‚ä¹Ÿå¯ä»¥ç«äº‰åˆ°é”~è¿™çœŸæ˜¯ä¸€ä¸ªæå…¶æ¶åŠ£çš„å¾ªç¯ã€‚è¿™ä¸ªæ—¶å€™åªèƒ½ä¾èµ–åº“å­˜æ ¡éªŒï¼Œä½†æ˜¯åååº“å­˜æ ¡éªŒä¸æ˜¯éåŸå­æ€§çš„ï¼Œé‡‡ç”¨çš„æ˜¯get and compare çš„æ–¹å¼ï¼Œè¶…å–çš„æ‚²å‰§å°±è¿™æ ·å‘ç”Ÿäº†~~~

### äº‹æ•…åˆ†æ

ä»”ç»†åˆ†æä¸‹æ¥ï¼Œå¯ä»¥å‘ç°ï¼Œè¿™ä¸ªæŠ¢è´­æ¥å£åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œæ˜¯æœ‰ä¸¥é‡çš„å®‰å…¨éšæ‚£çš„ï¼Œä¸»è¦é›†ä¸­åœ¨ä¸‰ä¸ªåœ°æ–¹ï¼š

- æ²¡æœ‰å…¶ä»–ç³»ç»Ÿé£é™©å®¹é”™å¤„ç†

ç”±äºç”¨æˆ·æœåŠ¡åƒç´§ï¼Œç½‘å…³å“åº”å»¶è¿Ÿï¼Œä½†æ²¡æœ‰ä»»ä½•åº”å¯¹æ–¹å¼ï¼Œè¿™æ˜¯è¶…å–çš„å¯¼ç«ç´¢ã€‚

- çœ‹ä¼¼å®‰å…¨çš„åˆ†å¸ƒå¼é”å…¶å®ä¸€ç‚¹éƒ½ä¸å®‰å…¨

è™½ç„¶é‡‡ç”¨äº†set key value [EX seconds] [PX milliseconds] [NX|XX]çš„æ–¹å¼ï¼Œä½†æ˜¯å¦‚æœçº¿ç¨‹Aæ‰§è¡Œçš„æ—¶é—´è¾ƒé•¿æ²¡æœ‰æ¥å¾—åŠé‡Šæ”¾ï¼Œé”å°±è¿‡æœŸäº†ï¼Œæ­¤æ—¶çº¿ç¨‹Bæ˜¯å¯ä»¥è·å–åˆ°é”çš„ã€‚å½“çº¿ç¨‹Aæ‰§è¡Œå®Œæˆä¹‹åï¼Œé‡Šæ”¾é”ï¼Œå®é™…ä¸Šå°±æŠŠçº¿ç¨‹Bçš„é”é‡Šæ”¾æ‰äº†ã€‚è¿™ä¸ªæ—¶å€™ï¼Œçº¿ç¨‹Cåˆæ˜¯å¯ä»¥è·å–åˆ°é”çš„ï¼Œè€Œæ­¤æ—¶å¦‚æœçº¿ç¨‹Bæ‰§è¡Œå®Œé‡Šæ”¾é”å®é™…ä¸Šå°±æ˜¯é‡Šæ”¾çš„çº¿ç¨‹Cè®¾ç½®çš„é”ã€‚è¿™æ˜¯è¶…å–çš„ç›´æ¥åŸå› ã€‚

- éåŸå­æ€§çš„åº“å­˜æ ¡éªŒ

éåŸå­æ€§çš„åº“å­˜æ ¡éªŒå¯¼è‡´åœ¨å¹¶å‘åœºæ™¯ä¸‹ï¼Œåº“å­˜æ ¡éªŒçš„ç»“æœä¸å‡†ç¡®ã€‚è¿™æ˜¯è¶…å–çš„æ ¹æœ¬åŸå› ã€‚

é€šè¿‡ä»¥ä¸Šåˆ†æï¼Œé—®é¢˜çš„æ ¹æœ¬åŸå› åœ¨äºåº“å­˜æ ¡éªŒä¸¥é‡ä¾èµ–äº†åˆ†å¸ƒå¼é”ã€‚å› ä¸ºåœ¨åˆ†å¸ƒå¼é”æ­£å¸¸setã€delçš„æƒ…å†µä¸‹ï¼Œåº“å­˜æ ¡éªŒæ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚ä½†æ˜¯ï¼Œå½“åˆ†å¸ƒå¼é”ä¸å®‰å…¨å¯é çš„æ—¶å€™ï¼Œåº“å­˜æ ¡éªŒå°±æ²¡æœ‰ç”¨äº†ã€‚

### è§£å†³æ–¹æ¡ˆ

çŸ¥é“äº†åŸå› ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥å¯¹ç—‡ä¸‹è¯äº†ã€‚

#### å®ç°ç›¸å¯¹å®‰å…¨çš„åˆ†å¸ƒå¼é”

ç›¸å¯¹å®‰å…¨çš„å®šä¹‰ï¼šsetã€delæ˜¯ä¸€ä¸€æ˜ å°„çš„ï¼Œä¸ä¼šå‡ºç°æŠŠå…¶ä»–ç°æˆçš„é”delçš„æƒ…å†µã€‚ä»å®é™…æƒ…å†µçš„è§’åº¦æ¥çœ‹ï¼Œå³ä½¿èƒ½åšåˆ°setã€delä¸€ä¸€æ˜ å°„ï¼Œä¹Ÿæ— æ³•ä¿éšœä¸šåŠ¡çš„ç»å¯¹å®‰å…¨ã€‚å› ä¸ºé”çš„è¿‡æœŸæ—¶é—´å§‹ç»ˆæ˜¯æœ‰ç•Œçš„ï¼Œé™¤éä¸è®¾ç½®è¿‡æœŸæ—¶é—´æˆ–è€…æŠŠè¿‡æœŸæ—¶é—´è®¾ç½®çš„å¾ˆé•¿ï¼Œä½†è¿™æ ·åšä¹Ÿä¼šå¸¦æ¥å…¶ä»–é—®é¢˜ã€‚æ•…æ²¡æœ‰æ„ä¹‰ã€‚è¦æƒ³å®ç°ç›¸å¯¹å®‰å…¨çš„åˆ†å¸ƒå¼é”ï¼Œå¿…é¡»ä¾èµ–keyçš„valueå€¼ã€‚åœ¨é‡Šæ”¾é”çš„æ—¶å€™ï¼Œé€šè¿‡valueå€¼çš„å”¯ä¸€æ€§æ¥ä¿è¯ä¸ä¼šå‹¿åˆ ã€‚æˆ‘ä»¬åŸºäºLUAè„šæœ¬å®ç°åŸå­æ€§çš„get and compareï¼Œå¦‚ä¸‹ï¼š

```
public void safedUnLock(String key, String val) {
    String luaScript = "local in = ARGV[1] local curr=redis.call('get', KEYS[1]) if in==curr then redis.call('del', KEYS[1]) end return 'OK'"";
    RedisScript<String> redisScript = RedisScript.of(luaScript);
    redisTemplate.execute(redisScript, Collections.singletonList(key), Collections.singleton(val));
}
```

æˆ‘ä»¬é€šè¿‡LUAè„šæœ¬æ¥å®ç°å®‰å…¨åœ°è§£é”ã€‚

#### å®ç°å®‰å…¨çš„åº“å­˜æ ¡éªŒ

å¦‚æœæˆ‘ä»¬å¯¹äºå¹¶å‘æœ‰æ¯”è¾ƒæ·±å…¥çš„äº†è§£çš„è¯ï¼Œä¼šå‘ç°æƒ³ get and compare/ read and save ç­‰æ“ä½œï¼Œéƒ½æ˜¯éåŸå­æ€§çš„ã€‚å¦‚æœè¦å®ç°åŸå­æ€§ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å€ŸåŠ©LUAè„šæœ¬æ¥å®ç°ã€‚ä½†å°±æˆ‘ä»¬è¿™ä¸ªä¾‹å­ä¸­ï¼Œç”±äºæŠ¢è´­æ´»åŠ¨ä¸€å•åªèƒ½ä¸‹1ç“¶ï¼Œå› æ­¤å¯ä»¥ä¸ç”¨åŸºäºLUAè„šæœ¬å®ç°è€Œæ˜¯åŸºäºredisæœ¬èº«çš„åŸå­æ€§ã€‚åŸå› åœ¨äºï¼š

```
// redisä¼šè¿”å›æ“ä½œä¹‹åçš„ç»“æœï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯åŸå­æ€§çš„
Long currStock = redisTemplate.opsForHash().increment("key", "stock", -1);
```

å‘ç°æ²¡æœ‰ï¼Œä»£ç ä¸­çš„åº“å­˜æ ¡éªŒå®Œå…¨æ˜¯â€œç”»è›‡æ·»è¶³â€ã€‚

#### æ”¹è¿›ä¹‹åçš„ä»£ç 

ç»è¿‡ä»¥ä¸Šçš„åˆ†æä¹‹åï¼Œæˆ‘ä»¬å†³å®šæ–°å»ºä¸€ä¸ªDistributedLockerç±»ä¸“é—¨ç”¨äºå¤„ç†åˆ†å¸ƒå¼é”ã€‚

```
public SeckillActivityRequestVO seckillHandle(SeckillActivityRequestVO request) {
SeckillActivityRequestVO response;
    String key = "key:" + request.getSeckillId();
    String val = UUID.randomUUID().toString();
    try {
        Boolean lockFlag = distributedLocker.lock(key, val, 10, TimeUnit.SECONDS);
        if (!lockFlag) {
            // ä¸šåŠ¡å¼‚å¸¸
        }

        // ç”¨æˆ·æ´»åŠ¨æ ¡éªŒ
        // åº“å­˜æ ¡éªŒï¼ŒåŸºäºredisæœ¬èº«çš„åŸå­æ€§æ¥ä¿è¯
        Long currStock = stringRedisTemplate.opsForHash().increment(key + ":info", "stock", -1);
        if (currStock < 0) { // è¯´æ˜åº“å­˜å·²ç»æ‰£å‡å®Œäº†ã€‚
            // ä¸šåŠ¡å¼‚å¸¸ã€‚
            log.error("[æŠ¢è´­ä¸‹å•] æ— åº“å­˜");
        } else {
            // ç”Ÿæˆè®¢å•
            // å‘å¸ƒè®¢å•åˆ›å»ºæˆåŠŸäº‹ä»¶
            // æ„å»ºå“åº”
        }
    } finally {
        distributedLocker.safedUnLock(key, val);
        // æ„å»ºå“åº”
    }
    return response;
}
```

### æ·±åº¦æ€è€ƒ

#### åˆ†å¸ƒå¼é”æœ‰å¿…è¦ä¹ˆ

æ”¹è¿›ä¹‹åï¼Œå…¶å®å¯ä»¥å‘ç°ï¼Œæˆ‘ä»¬å€ŸåŠ©äºredisæœ¬èº«çš„åŸå­æ€§æ‰£å‡åº“å­˜ï¼Œä¹Ÿæ˜¯å¯ä»¥ä¿è¯ä¸ä¼šè¶…å–çš„ã€‚å¯¹çš„ã€‚ä½†æ˜¯å¦‚æœæ²¡æœ‰è¿™ä¸€å±‚é”çš„è¯ï¼Œé‚£ä¹ˆæ‰€æœ‰è¯·æ±‚è¿›æ¥éƒ½ä¼šèµ°ä¸€éä¸šåŠ¡é€»è¾‘ï¼Œç”±äºä¾èµ–äº†å…¶ä»–ç³»ç»Ÿï¼Œæ­¤æ—¶å°±ä¼šé€ æˆå¯¹å…¶ä»–ç³»ç»Ÿçš„å‹åŠ›å¢å¤§ã€‚è¿™ä¼šå¢åŠ çš„æ€§èƒ½æŸè€—å’ŒæœåŠ¡ä¸ç¨³å®šæ€§ï¼Œå¾—ä¸å¿å¤±ã€‚åŸºäºåˆ†å¸ƒå¼é”å¯ä»¥åœ¨ä¸€å®šç¨‹åº¦ä¸Šæ‹¦æˆªä¸€äº›æµé‡ã€‚

#### åˆ†å¸ƒå¼é”çš„é€‰å‹

æœ‰äººæå‡ºç”¨RedLockæ¥å®ç°åˆ†å¸ƒå¼é”ã€‚RedLockçš„å¯é æ€§æ›´é«˜ï¼Œä½†å…¶ä»£ä»·æ˜¯ç‰ºç‰²ä¸€å®šçš„æ€§èƒ½ã€‚åœ¨æœ¬åœºæ™¯ï¼Œè¿™ç‚¹å¯é æ€§çš„æå‡è¿œä¸å¦‚æ€§èƒ½çš„æå‡å¸¦æ¥çš„æ€§ä»·æ¯”é«˜ã€‚å¦‚æœå¯¹äºå¯é æ€§æé«˜è¦æ±‚çš„åœºæ™¯ï¼Œåˆ™å¯ä»¥é‡‡ç”¨RedLockæ¥å®ç°ã€‚

#### å†æ¬¡æ€è€ƒåˆ†å¸ƒå¼é”æœ‰å¿…è¦ä¹ˆ

ç”±äºbugéœ€è¦ç´§æ€¥ä¿®å¤ä¸Šçº¿ï¼Œå› æ­¤æˆ‘ä»¬å°†å…¶ä¼˜åŒ–å¹¶åœ¨æµ‹è¯•ç¯å¢ƒè¿›è¡Œäº†å‹æµ‹ä¹‹åï¼Œå°±ç«‹é©¬çƒ­éƒ¨ç½²ä¸Šçº¿äº†ã€‚å®é™…è¯æ˜ï¼Œè¿™ä¸ªä¼˜åŒ–æ˜¯æˆåŠŸçš„ï¼Œæ€§èƒ½æ–¹é¢ç•¥å¾®æå‡äº†ä¸€äº›ï¼Œå¹¶åœ¨åˆ†å¸ƒå¼é”å¤±æ•ˆçš„æƒ…å†µä¸‹ï¼Œæ²¡æœ‰å‡ºç°è¶…å–çš„æƒ…å†µã€‚ç„¶è€Œï¼Œè¿˜æœ‰æ²¡æœ‰ä¼˜åŒ–ç©ºé—´å‘¢ï¼Ÿæœ‰çš„ï¼ç”±äºæœåŠ¡æ˜¯é›†ç¾¤éƒ¨ç½²ï¼Œæˆ‘ä»¬å¯ä»¥å°†åº“å­˜å‡æ‘Šåˆ°é›†ç¾¤ä¸­çš„æ¯ä¸ªæœåŠ¡å™¨ä¸Šï¼Œé€šè¿‡å¹¿æ’­é€šçŸ¥åˆ°é›†ç¾¤çš„å„ä¸ªæœåŠ¡å™¨ã€‚ç½‘å…³å±‚åŸºäºç”¨æˆ·IDåšhashç®—æ³•æ¥å†³å®šè¯·æ±‚åˆ°å“ªä¸€å°æœåŠ¡å™¨ã€‚è¿™æ ·å°±å¯ä»¥åŸºäºåº”ç”¨ç¼“å­˜æ¥å®ç°åº“å­˜çš„æ‰£å‡å’Œåˆ¤æ–­ã€‚æ€§èƒ½åˆè¿›ä¸€æ­¥æå‡äº†ï¼

```
// é€šè¿‡æ¶ˆæ¯æå‰åˆå§‹åŒ–å¥½ï¼Œå€ŸåŠ©ConcurrentHashMapå®ç°é«˜æ•ˆçº¿ç¨‹å®‰å…¨
private static ConcurrentHashMap<Long, Boolean> SECKILL_FLAG_MAP = new ConcurrentHashMap<>();
// é€šè¿‡æ¶ˆæ¯æå‰è®¾ç½®å¥½ã€‚ç”±äºAtomicIntegeræœ¬èº«å…·å¤‡åŸå­æ€§ï¼Œå› æ­¤è¿™é‡Œå¯ä»¥ç›´æ¥ä½¿ç”¨HashMap
private static Map<Long, AtomicInteger> SECKILL_STOCK_MAP = new HashMap<>();

...

public SeckillActivityRequestVO seckillHandle(SeckillActivityRequestVO request) {
SeckillActivityRequestVO response;

    Long seckillId = request.getSeckillId();
    if(!SECKILL_FLAG_MAP.get(requestseckillId)) {
        // ä¸šåŠ¡å¼‚å¸¸
    }
     // ç”¨æˆ·æ´»åŠ¨æ ¡éªŒ
     // åº“å­˜æ ¡éªŒ
    if(SECKILL_STOCK_MAP.get(seckillId).decrementAndGet() < 0) {
        SECKILL_FLAG_MAP.put(seckillId, false);
        // ä¸šåŠ¡å¼‚å¸¸
    }
    // ç”Ÿæˆè®¢å•
    // å‘å¸ƒè®¢å•åˆ›å»ºæˆåŠŸäº‹ä»¶
    // æ„å»ºå“åº”
    return response;
}
```

é€šè¿‡ä»¥ä¸Šçš„æ”¹é€ ï¼Œæˆ‘ä»¬å°±å®Œå…¨ä¸éœ€è¦ä¾èµ–redisäº†ã€‚æ€§èƒ½å’Œå®‰å…¨æ€§ä¸¤æ–¹é¢éƒ½èƒ½è¿›ä¸€æ­¥å¾—åˆ°æå‡ï¼å½“ç„¶ï¼Œæ­¤æ–¹æ¡ˆæ²¡æœ‰è€ƒè™‘åˆ°æœºå™¨çš„åŠ¨æ€æ‰©å®¹ã€ç¼©å®¹ç­‰å¤æ‚åœºæ™¯ï¼Œå¦‚æœè¿˜è¦è€ƒè™‘è¿™äº›è¯ï¼Œåˆ™ä¸å¦‚ç›´æ¥è€ƒè™‘åˆ†å¸ƒå¼é”çš„è§£å†³æ–¹æ¡ˆã€‚

### æ€»ç»“

ç¨€ç¼ºå•†å“è¶…å–ç»å¯¹æ˜¯é‡å¤§äº‹æ•…ã€‚å¦‚æœè¶…å–æ•°é‡å¤šçš„è¯ï¼Œç”šè‡³ä¼šç»™å¹³å°å¸¦æ¥éå¸¸ä¸¥é‡çš„ç»è¥å½±å“å’Œç¤¾ä¼šå½±å“ã€‚ç»è¿‡æœ¬æ¬¡äº‹æ•…ï¼Œè®©æˆ‘æ„è¯†åˆ°å¯¹äºé¡¹ç›®ä¸­çš„ä»»ä½•ä¸€è¡Œä»£ç éƒ½ä¸èƒ½æ‰ä»¥è½»å¿ƒï¼Œå¦åˆ™åœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œè¿™äº›æ­£å¸¸å·¥ä½œçš„ä»£ç å°±ä¼šå˜æˆè‡´å‘½æ€æ‰‹ï¼å¯¹äºä¸€ä¸ªå¼€å‘è€…è€Œè¨€ï¼Œåˆ™è®¾è®¡å¼€å‘æ–¹æ¡ˆæ—¶ï¼Œä¸€å®šè¦å°†æ–¹æ¡ˆè€ƒè™‘å‘¨å…¨ã€‚æ€æ ·æ‰èƒ½å°†æ–¹æ¡ˆè€ƒè™‘å‘¨å…¨ï¼Ÿå”¯æœ‰æŒç»­ä¸æ–­åœ°å­¦ä¹ ï¼

PSï¼šå¦‚æœè§‰å¾—æˆ‘çš„åˆ†äº«ä¸é”™ï¼Œæ¬¢è¿å¤§å®¶éšæ‰‹ç‚¹èµã€åœ¨çœ‹ã€‚

é˜…è¯» 6091

åˆ†äº«æ”¶è—

èµ36åœ¨çœ‹15

å†™ä¸‹ä½ çš„ç•™è¨€

**ç²¾é€‰ç•™è¨€**

- ![img](http://wx.qlogo.cn/mmopen/tRjpciabvanD664m7aSUhT5iaSxGGm3dibWFJLBpPsllnaquH2kPa1ABseSHK8BC0icSkY9GrBZBRGH0Q9NZia93S6Ahb6ywK4fJg/96)

  CookğŸ¦Šfanâ¶â¶â¶

  1

  

  è¿™ç§æ€»ç»“ä¸åº”è¯¥æ˜¯2å¹´å‰çš„äº‹äº†å—ï¼Œç°åœ¨æ‰å‘å‡ºæ¥

- ![img](http://wx.qlogo.cn/mmopen/ajNVdqHZLLDs0q5ufJ5Sib95HbXrctCb0UnNqlWwACJ05ItRibGjhVlccTcJr2sHhvHX2w98v1R7bTB23XFmPYCGNYxmmMzF0c72HsZicT68HI/96)

  è¿é£

  1

  

  åŸºäºredisçš„é«˜æ•ˆå®‰å…¨çš„åˆ†å¸ƒå¼é”ã€åˆ†å¸ƒå¼è¯»å†™é”ã€åˆ†å¸ƒå¼ä¿¡å·é‡ã€‚æä¾›æ³¨è§£ï¼Œä½¿ç”¨ç®€å•ï¼Œå¯ä¸spring-bootæ— ç¼é›†æˆã€‚https://github.com/zhongxunking/sync

- ![img](http://wx.qlogo.cn/mmopen/PiajxSqBRaEI0ibmpIVfLRAXpJBBaprAtobASHESMRbntfNLmCREDQtdsOCI1pUibJV4o20SxsqibibRZE53FddibuWg/96)

  ğŸ‡­ ğŸ‡» ğŸ‡¦ ğŸ‡© ğŸ‡»

  

  Redisionçœ‹é—¨ç‹—ğŸ¶ ä¹Ÿå¯ä»¥è§£å†³

- ![img](http://wx.qlogo.cn/mmopen/Q3auHgzwzM48SHZArM06vrRfgEOmaD6LvVHM6rlvpBFO6PjFA8bpj3lopOibJ0yVbqTyvGFhzicC9foU5WUlX9Cncm4ObEqYICLekwP4rNAHg/96)

  å­¦ä¹ ä½¿æˆ‘ å¤œä¸èƒ½å¯ æ‰¶å¢™è€Œèµ°

  

  ç»©æ•ˆè¢«æ‰£çš„é¢†æ‚Ÿ

- ![img](http://wx.qlogo.cn/mmopen/Q3auHgzwzM48SHZArM06vrRfgEOmaD6Le9ZEQIdJA80WibxzatVokKF7KLFNbAibeIrpXuHO814ckNAzXvQppTjnwxRflMAn4DE3CWuBoH6o4/96)

  ÏionÃ«â„“à¹‘

  

  æˆ‘æ„Ÿè§‰ä¼˜åŒ–åçš„ä»£ç å’Œä¼˜åŒ–å‰çš„ä»£ç å¹¶æ²¡æœ‰åŒºåˆ«

- ![img](http://wx.qlogo.cn/mmopen/qI4Sa4eQq42uox0BbIXKBL3539jcicTiaD9GscKicLjo3zU0LW5yjwblzh6OHCWtNzY5M7dBqvuf1ElNeyO5SSUoxVUMm8ibNfbB/96)

  èµµå·

  

  Redissionå®ç°redisçš„åˆ†å¸ƒå¼é”ï¼Œç›´æ¥ç”¨å°±è¡Œäº†

- ![img](http://wx.qlogo.cn/mmopen/tRjpciabvanCONW4SnbJbhyTiaNHL7w5xLGLibeFNFmWvTucmodW2Y3Ygib5S7qQgZn5MibXsCBscKOnEs9USmA4QdwNcES1R3RRu/96)

  ç»®æ¢¦

  

  ç”¨æˆ·æ ¡éªŒä¸ºä»€ä¹ˆä¸æå‰å°±æ ¡éªŒè€Œå†™åœ¨è¿™é‡Œå‘¢ï¼Ÿ

- ![img](http://wx.qlogo.cn/mmopen/Q3auHgzwzM5DXBr9Fj9bz8cibGLP5ho8bicWmgHvzRJ18zXMMetmbEM4PJYhicPNhz4EJ74AVsghlQURq9tIfEI7A/96)

  lee

  

  é‚£ä½ ä¸è¦ç”¨redisåˆ†å¸ƒå¼é”ï¼Œç”¨zook eeperå‘¢ğŸ˜‰

- ![img](http://wx.qlogo.cn/mmopen/Q3auHgzwzM4eSiaia1AoNkVlXRYrpnfqw8HyDdhDk4kIWciaB7a5tibaUbyiaymOpqibIKEmZpMx8pH2j7MfQeYDKx8xq1mgwZicn87wGjoyIkMMBM/96)

  ç‹é”¦æ¶›

  

  èŒ…å°ï¼Ÿå…è´¹é€æˆ‘éƒ½æ²¡è¦ï¼Œå“ªæœ‰ä»£ç å°±èŒ¶é¦™

- ![img](http://wx.qlogo.cn/mmopen/zde386CYzHYbic9E3hUVLuiaCdFYQcIIEZXn7iaklRjI9ZXmiclutX5hap0rciaj1MbAHOU8TuxcfH3LLVDh9O0TbQN1vE9y1SGSp/96)

  ç§‹æ—¥æš–é˜³

  

  æ·±æ·±åœ°ä¸Šå•¦ä¸€è¯¾

- ![img](http://wx.qlogo.cn/mmopen/ajNVdqHZLLDNiaUTBTHibMvJ0vDtYOlFuHeTzPqbCKdHDe8kWJz7VxUaDVNnCMpvEpUOxJAc6ibKFGVCgEUsdKcJriagteAoQRoAFlSJ9CfQUzU/96)

  ZhouLi

  

  ç›´æ¥ç”¨stringç±»å‹çš„èŠ‚ç›®decræ“ä½œä¹Ÿèƒ½è¾¾åˆ°ç›¸åŒçš„æ•ˆæœå§ï¼Ÿ Setnx(stock_number, 10); A = decr(stock_number);

  ![img](http://wx.qlogo.cn/mmopen/ajNVdqHZLLDNiaUTBTHibMvJ0vDtYOlFuHeTzPqbCKdHDe8kWJz7VxUaDVNnCMpvEpUOxJAc6ibKFGVCgEUsdKcJriagteAoQRoAFlSJ9CfQUzU/96)

  ZhouLi

  

  If A < 0: æ— åº“å­˜

- ![img](http://wx.qlogo.cn/mmopen/dWYcndbpDnbcsXmqGazK5KBJPUmDq9Q6APHk4dMhGSYnavHEzJ7QDINn17ZY0ImBm0Qy1zF7toCgU9PibmibFzIYAXibGJhvoBA/96)

  é‚‚é€…æ¨±èŠ±

  

  è¿˜æœ‰sqlå±‚é¢ï¼Œæ‰£å‡æ›´æ–°æ“ä½œï¼Œå¢åŠ whereåº“å­˜æ¯”è¾ƒæ¡ä»¶

- ![img](http://wx.qlogo.cn/mmopen/zde386CYzHZM1cBYGAXGLGaFbricrQoy4aebmcZUPUa9rmddLb9WJqNzp2fE6KbeCPW2rK97ekZo3t1zoY4dDAQyAGelNIO64/96)

  æ´ªç‡Š

  

  æƒ³è¯·æ•™ä¸€ä¸‹ï¼Œæœ€åä¼˜åŒ–åçš„ä»£ç ä¸­ï¼Œé‚£ä¸¤ä¸ªmapä»€ä¹ˆæ—¶å€™setå€¼å•Šï¼Ÿ

- ![img](http://wx.qlogo.cn/mmopen/ajNVdqHZLLCXuCAuk0B2P1ARkgZqIAQTwibEGuIanwCGlm63SibqjM2v59B3eo2cBlq41P3ksDEElpSRhcQbTcIQ/96)

  åœ¨ä¸‹ä½•é”´è±ªã€‚

  

  å¦‚æœredisçš„é«˜å¯ç”¨éƒ½ä¸èƒ½ä¿è¯ï¼Œè¿˜ä¸å¦‚ç›´æ¥ç”¨å•æœºç³»ç»Ÿ

- ![img](http://wx.qlogo.cn/mmopen/Q3auHgzwzM48SHZArM06vrRfgEOmaD6L87d6epfosMm92WOrc2m1uA0LCstpET7XwqMR3qc8yxllcsCEmEC8osFUlTOzyBNialVZibBgmZzfw/96)

  vate

  

  ç”¨redissionä¸å°±å¥½äº†ï¼Œredissiinä¼šè‡ªåŠ¨ç»­æœŸ