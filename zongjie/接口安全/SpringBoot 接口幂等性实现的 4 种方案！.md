## SpringBoot æ¥å£å¹‚ç­‰æ€§å®ç°çš„ 4 ç§æ–¹æ¡ˆï¼è¿™ä¸ªæˆ‘çœŸçš„æœæ°”äº†ï¼

ç‚¹å‡»å…³æ³¨ ğŸ‘‰ [å†™ä»£ç çš„æ¸£æ¸£é¹](javascript:void(0);) *3æœˆ11æ—¥*



æ¥æºï¼šmydlq.club/article/94/

- ä¸€ã€ä»€ä¹ˆæ˜¯å¹‚ç­‰æ€§

- äºŒã€ä»€ä¹ˆæ˜¯æ¥å£å¹‚ç­‰æ€§

- ä¸‰ã€ä¸ºä»€ä¹ˆéœ€è¦å®ç°å¹‚ç­‰æ€§

- å››ã€å¼•å…¥å¹‚ç­‰æ€§åå¯¹ç³»ç»Ÿçš„å½±å“

- äº”ã€Restful API æ¥å£çš„å¹‚ç­‰æ€§

- å…­ã€å¦‚ä½•å®ç°å¹‚ç­‰æ€§

- - æ–¹æ¡ˆä¸€ï¼šæ•°æ®åº“å”¯ä¸€ä¸»é”®
  - æ–¹æ¡ˆäºŒï¼šæ•°æ®åº“ä¹è§‚é”
  - æ–¹æ¡ˆä¸‰ï¼šé˜²é‡ Token ä»¤ç‰Œ
  - æ–¹æ¡ˆå››ã€ä¸‹æ¸¸ä¼ é€’å”¯ä¸€åºåˆ—å·

- ä¸ƒã€å®ç°æ¥å£å¹‚ç­‰ç¤ºä¾‹

- - 1ã€Maven å¼•å…¥ç›¸å…³ä¾èµ–
  - 2ã€é…ç½®è¿æ¥ Redis çš„å‚æ•°
  - 3ã€åˆ›å»ºä¸éªŒè¯ Token å·¥å…·ç±»
  - 4ã€åˆ›å»ºæµ‹è¯•çš„ Controller ç±»
  - 5ã€åˆ›å»º SpringBoot å¯åŠ¨ç±»
  - 6ã€å†™æµ‹è¯•ç±»è¿›è¡Œæµ‹è¯•

- å…«ã€æœ€åæ€»ç»“



------

**ç³»ç»Ÿç¯å¢ƒï¼š**

- Java JDK ç‰ˆæœ¬ï¼š1.8
- SpringBoot ç‰ˆæœ¬ï¼š2.3.4.RELEASE

# ä¸€ã€ä»€ä¹ˆæ˜¯å¹‚ç­‰æ€§

å¹‚ç­‰æ˜¯ä¸€ä¸ªæ•°å­¦ä¸è®¡ç®—æœºå­¦æ¦‚å¿µï¼Œåœ¨æ•°å­¦ä¸­æŸä¸€å…ƒè¿ç®—ä¸ºå¹‚ç­‰æ—¶ï¼Œå…¶ä½œç”¨åœ¨ä»»ä¸€å…ƒç´ ä¸¤æ¬¡åä¼šå’Œå…¶ä½œç”¨ä¸€æ¬¡çš„ç»“æœç›¸åŒã€‚åœ¨è®¡ç®—æœºä¸­ç¼–ç¨‹ä¸­ï¼Œä¸€ä¸ªå¹‚ç­‰æ“ä½œçš„ç‰¹ç‚¹æ˜¯å…¶ä»»æ„å¤šæ¬¡æ‰§è¡Œæ‰€äº§ç”Ÿçš„å½±å“å‡ä¸ä¸€æ¬¡æ‰§è¡Œçš„å½±å“ç›¸åŒã€‚å¹‚ç­‰å‡½æ•°æˆ–å¹‚ç­‰æ–¹æ³•æ˜¯æŒ‡å¯ä»¥ä½¿ç”¨ç›¸åŒå‚æ•°é‡å¤æ‰§è¡Œï¼Œå¹¶èƒ½è·å¾—ç›¸åŒç»“æœçš„å‡½æ•°ã€‚è¿™äº›å‡½æ•°ä¸ä¼šå½±å“ç³»ç»ŸçŠ¶æ€ï¼Œä¹Ÿä¸ç”¨æ‹…å¿ƒé‡å¤æ‰§è¡Œä¼šå¯¹ç³»ç»Ÿé€ æˆæ”¹å˜ã€‚

# äºŒã€ä»€ä¹ˆæ˜¯æ¥å£å¹‚ç­‰æ€§

åœ¨HTTP/1.1ä¸­ï¼Œå¯¹å¹‚ç­‰æ€§è¿›è¡Œäº†å®šä¹‰ã€‚å®ƒæè¿°äº†ä¸€æ¬¡å’Œå¤šæ¬¡è¯·æ±‚æŸä¸€ä¸ªèµ„æºå¯¹äºèµ„æºæœ¬èº«åº”è¯¥å…·æœ‰åŒæ ·çš„ç»“æœï¼ˆç½‘ç»œè¶…æ—¶ç­‰é—®é¢˜é™¤å¤–ï¼‰ï¼Œå³ç¬¬ä¸€æ¬¡è¯·æ±‚çš„æ—¶å€™å¯¹èµ„æºäº§ç”Ÿäº†å‰¯ä½œç”¨ï¼Œä½†æ˜¯ä»¥åçš„å¤šæ¬¡è¯·æ±‚éƒ½ä¸ä¼šå†å¯¹èµ„æºäº§ç”Ÿå‰¯ä½œç”¨ã€‚è¿™é‡Œçš„å‰¯ä½œç”¨æ˜¯ä¸ä¼šå¯¹ç»“æœäº§ç”Ÿç ´åæˆ–è€…äº§ç”Ÿä¸å¯é¢„æ–™çš„ç»“æœã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå…¶ä»»æ„å¤šæ¬¡æ‰§è¡Œå¯¹èµ„æºæœ¬èº«æ‰€äº§ç”Ÿçš„å½±å“å‡ä¸ä¸€æ¬¡æ‰§è¡Œçš„å½±å“ç›¸åŒã€‚

# ä¸‰ã€ä¸ºä»€ä¹ˆéœ€è¦å®ç°å¹‚ç­‰æ€§

åœ¨æ¥å£è°ƒç”¨æ—¶ä¸€èˆ¬æƒ…å†µä¸‹éƒ½èƒ½æ­£å¸¸è¿”å›ä¿¡æ¯ä¸ä¼šé‡å¤æäº¤ï¼Œä¸è¿‡åœ¨é‡è§ä»¥ä¸‹æƒ…å†µæ—¶å¯ä»¥å°±ä¼šå‡ºç°é—®é¢˜ï¼Œå¦‚ï¼š

- **å‰ç«¯é‡å¤æäº¤è¡¨å•ï¼š** åœ¨å¡«å†™ä¸€äº›è¡¨æ ¼æ—¶å€™ï¼Œç”¨æˆ·å¡«å†™å®Œæˆæäº¤ï¼Œå¾ˆå¤šæ—¶å€™ä¼šå› ç½‘ç»œæ³¢åŠ¨æ²¡æœ‰åŠæ—¶å¯¹ç”¨æˆ·åšå‡ºæäº¤æˆåŠŸå“åº”ï¼Œè‡´ä½¿ç”¨æˆ·è®¤ä¸ºæ²¡æœ‰æˆåŠŸæäº¤ï¼Œç„¶åä¸€ç›´ç‚¹æäº¤æŒ‰é’®ï¼Œè¿™æ—¶å°±ä¼šå‘ç”Ÿé‡å¤æäº¤è¡¨å•è¯·æ±‚ã€‚
- **ç”¨æˆ·æ¶æ„è¿›è¡Œåˆ·å•ï¼š** ä¾‹å¦‚åœ¨å®ç°ç”¨æˆ·æŠ•ç¥¨è¿™ç§åŠŸèƒ½æ—¶ï¼Œå¦‚æœç”¨æˆ·é’ˆå¯¹ä¸€ä¸ªç”¨æˆ·è¿›è¡Œé‡å¤æäº¤æŠ•ç¥¨ï¼Œè¿™æ ·ä¼šå¯¼è‡´æ¥å£æ¥æ”¶åˆ°ç”¨æˆ·é‡å¤æäº¤çš„æŠ•ç¥¨ä¿¡æ¯ï¼Œè¿™æ ·ä¼šä½¿æŠ•ç¥¨ç»“æœä¸äº‹å®ä¸¥é‡ä¸ç¬¦ã€‚
- **æ¥å£è¶…æ—¶é‡å¤æäº¤ï¼š** å¾ˆå¤šæ—¶å€™ HTTP å®¢æˆ·ç«¯å·¥å…·éƒ½é»˜è®¤å¼€å¯è¶…æ—¶é‡è¯•çš„æœºåˆ¶ï¼Œå°¤å…¶æ˜¯ç¬¬ä¸‰æ–¹è°ƒç”¨æ¥å£æ—¶å€™ï¼Œä¸ºäº†é˜²æ­¢ç½‘ç»œæ³¢åŠ¨è¶…æ—¶ç­‰é€ æˆçš„è¯·æ±‚å¤±è´¥ï¼Œéƒ½ä¼šæ·»åŠ é‡è¯•æœºåˆ¶ï¼Œå¯¼è‡´ä¸€ä¸ªè¯·æ±‚æäº¤å¤šæ¬¡ã€‚
- **æ¶ˆæ¯è¿›è¡Œé‡å¤æ¶ˆè´¹ï¼š** å½“ä½¿ç”¨ MQ æ¶ˆæ¯ä¸­é—´ä»¶æ—¶å€™ï¼Œå¦‚æœå‘ç”Ÿæ¶ˆæ¯ä¸­é—´ä»¶å‡ºç°é”™è¯¯æœªåŠæ—¶æäº¤æ¶ˆè´¹ä¿¡æ¯ï¼Œå¯¼è‡´å‘ç”Ÿé‡å¤æ¶ˆè´¹ã€‚

ä½¿ç”¨å¹‚ç­‰æ€§æœ€å¤§çš„ä¼˜åŠ¿åœ¨äºä½¿æ¥å£ä¿è¯ä»»ä½•å¹‚ç­‰æ€§æ“ä½œï¼Œå…å»å› é‡è¯•ç­‰é€ æˆç³»ç»Ÿäº§ç”Ÿçš„æœªçŸ¥çš„é—®é¢˜ã€‚

# å››ã€å¼•å…¥å¹‚ç­‰æ€§åå¯¹ç³»ç»Ÿçš„å½±å“

å¹‚ç­‰æ€§æ˜¯ä¸ºäº†ç®€åŒ–å®¢æˆ·ç«¯é€»è¾‘å¤„ç†ï¼Œèƒ½æ”¾ç½®é‡å¤æäº¤ç­‰æ“ä½œï¼Œä½†å´å¢åŠ äº†æœåŠ¡ç«¯çš„é€»è¾‘å¤æ‚æ€§å’Œæˆæœ¬ï¼Œå…¶ä¸»è¦æ˜¯ï¼š

- æŠŠå¹¶è¡Œæ‰§è¡Œçš„åŠŸèƒ½æ”¹ä¸ºä¸²è¡Œæ‰§è¡Œï¼Œé™ä½äº†æ‰§è¡Œæ•ˆç‡ã€‚
- å¢åŠ äº†é¢å¤–æ§åˆ¶å¹‚ç­‰çš„ä¸šåŠ¡é€»è¾‘ï¼Œå¤æ‚åŒ–äº†ä¸šåŠ¡åŠŸèƒ½ï¼›

æ‰€ä»¥åœ¨ä½¿ç”¨æ—¶å€™éœ€è¦è€ƒè™‘æ˜¯å¦å¼•å…¥å¹‚ç­‰æ€§çš„å¿…è¦æ€§ï¼Œæ ¹æ®å®é™…ä¸šåŠ¡åœºæ™¯å…·ä½“åˆ†æï¼Œé™¤äº†ä¸šåŠ¡ä¸Šçš„ç‰¹æ®Šè¦æ±‚å¤–ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä¸éœ€è¦å¼•å…¥çš„æ¥å£å¹‚ç­‰æ€§ã€‚

# äº”ã€Restful API æ¥å£çš„å¹‚ç­‰æ€§

ç°åœ¨æµè¡Œçš„ Restful æ¨èçš„å‡ ç§ HTTP æ¥å£æ–¹æ³•ä¸­ï¼Œåˆ†åˆ«å­˜åœ¨å¹‚ç­‰è¡Œä¸ä¸èƒ½ä¿è¯å¹‚ç­‰çš„æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š

- âˆš æ»¡è¶³å¹‚ç­‰
- x ä¸æ»¡è¶³å¹‚ç­‰
- \- å¯èƒ½æ»¡è¶³ä¹Ÿå¯èƒ½ä¸æ»¡è¶³å¹‚ç­‰ï¼Œæ ¹æ®å®é™…ä¸šåŠ¡é€»è¾‘æœ‰å…³

| æ–¹æ³•ç±»å‹ | æ˜¯å¦å¹‚ç­‰ |                             æè¿°                             |
| :------: | :------: | :----------------------------------------------------------: |
|   Get    |    âˆš     | Get æ–¹æ³•ç”¨äºè·å–èµ„æºã€‚å…¶ä¸€èˆ¬ä¸ä¼šä¹Ÿä¸åº”å½“å¯¹ç³»ç»Ÿèµ„æºè¿›è¡Œæ”¹å˜ï¼Œæ‰€ä»¥æ˜¯å¹‚ç­‰çš„ã€‚ |
|   Post   |    Ã—     | Post æ–¹æ³•ä¸€èˆ¬ç”¨äºåˆ›å»ºæ–°çš„èµ„æºã€‚å…¶æ¯æ¬¡æ‰§è¡Œéƒ½ä¼šæ–°å¢æ•°æ®ï¼Œæ‰€ä»¥ä¸æ˜¯å¹‚ç­‰çš„ã€‚ |
|   Put    |    -     | Put æ–¹æ³•ä¸€èˆ¬ç”¨äºä¿®æ”¹èµ„æºã€‚è¯¥æ“ä½œåˆ™åˆ†æƒ…å†µæ¥åˆ¤æ–­æ˜¯ä¸æ˜¯æ»¡è¶³å¹‚ç­‰ï¼Œæ›´æ–°æ“ä½œä¸­ç›´æ¥æ ¹æ®æŸä¸ªå€¼è¿›è¡Œæ›´æ–°ï¼Œä¹Ÿèƒ½ä¿æŒå¹‚ç­‰ã€‚ä¸è¿‡æ‰§è¡Œç´¯åŠ æ“ä½œçš„æ›´æ–°æ˜¯éå¹‚ç­‰ã€‚ |
|  Delete  |    -     | Delete æ–¹æ³•ä¸€èˆ¬ç”¨äºåˆ é™¤èµ„æºã€‚è¯¥æ“ä½œåˆ™åˆ†æƒ…å†µæ¥åˆ¤æ–­æ˜¯ä¸æ˜¯æ»¡è¶³å¹‚ç­‰ï¼Œå½“æ ¹æ®å”¯ä¸€å€¼è¿›è¡Œåˆ é™¤æ—¶ï¼Œåˆ é™¤åŒä¸€ä¸ªæ•°æ®å¤šæ¬¡æ‰§è¡Œæ•ˆæœä¸€æ ·ã€‚ä¸è¿‡éœ€è¦æ³¨æ„ï¼Œå¸¦æŸ¥è¯¢æ¡ä»¶çš„åˆ é™¤åˆ™å°±ä¸ä¸€å®šæ»¡è¶³å¹‚ç­‰äº†ã€‚ä¾‹å¦‚åœ¨æ ¹æ®æ¡ä»¶åˆ é™¤ä¸€æ‰¹æ•°æ®åï¼Œè¿™æ—¶å€™æ–°å¢åŠ äº†ä¸€æ¡æ•°æ®ä¹Ÿæ»¡è¶³æ¡ä»¶ï¼Œç„¶ååˆæ‰§è¡Œäº†ä¸€æ¬¡åˆ é™¤ï¼Œé‚£ä¹ˆå°†ä¼šå¯¼è‡´æ–°å¢åŠ çš„è¿™æ¡æ»¡è¶³æ¡ä»¶æ•°æ®ä¹Ÿè¢«åˆ é™¤ã€‚ |

# å…­ã€å¦‚ä½•å®ç°å¹‚ç­‰æ€§

## æ–¹æ¡ˆä¸€ï¼šæ•°æ®åº“å”¯ä¸€ä¸»é”®

**æ–¹æ¡ˆæè¿°**

æ•°æ®åº“å”¯ä¸€ä¸»é”®çš„å®ç°ä¸»è¦æ˜¯åˆ©ç”¨æ•°æ®åº“ä¸­ä¸»é”®å”¯ä¸€çº¦æŸçš„ç‰¹æ€§ï¼Œä¸€èˆ¬æ¥è¯´å”¯ä¸€ä¸»é”®æ¯”è¾ƒé€‚ç”¨äºâ€œæ’å…¥â€æ—¶çš„å¹‚ç­‰æ€§ï¼Œå…¶èƒ½ä¿è¯ä¸€å¼ è¡¨ä¸­åªèƒ½å­˜åœ¨ä¸€æ¡å¸¦è¯¥å”¯ä¸€ä¸»é”®çš„è®°å½•ã€‚

ä½¿ç”¨æ•°æ®åº“å”¯ä¸€ä¸»é”®å®Œæˆå¹‚ç­‰æ€§æ—¶éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¯¥ä¸»é”®ä¸€èˆ¬æ¥è¯´å¹¶ä¸æ˜¯ä½¿ç”¨æ•°æ®åº“ä¸­è‡ªå¢ä¸»é”®ï¼Œè€Œæ˜¯ä½¿ç”¨åˆ†å¸ƒå¼ ID å……å½“ä¸»é”®ï¼ˆå¯ä»¥å‚è€ƒ Java ä¸­åˆ†å¸ƒå¼ ID çš„è®¾è®¡æ–¹æ¡ˆ è¿™ç¯‡æ–‡ç« ï¼‰ï¼Œè¿™æ ·æ‰èƒ½èƒ½ä¿è¯åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ ID çš„å…¨å±€å”¯ä¸€æ€§ã€‚

**é€‚ç”¨æ“ä½œï¼š**

- æ’å…¥æ“ä½œ
- åˆ é™¤æ“ä½œ

**ä½¿ç”¨é™åˆ¶ï¼š**

- éœ€è¦ç”Ÿæˆå…¨å±€å”¯ä¸€ä¸»é”® IDï¼›

**ä¸»è¦æµç¨‹ï¼š**

![å›¾ç‰‡](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

ä¸»è¦æµç¨‹ï¼š

- â‘  å®¢æˆ·ç«¯æ‰§è¡Œåˆ›å»ºè¯·æ±‚ï¼Œè°ƒç”¨æœåŠ¡ç«¯æ¥å£ã€‚
- â‘¡ æœåŠ¡ç«¯æ‰§è¡Œä¸šåŠ¡é€»è¾‘ï¼Œç”Ÿæˆä¸€ä¸ªåˆ†å¸ƒå¼ IDï¼Œå°†è¯¥ ID å……å½“å¾…æ’å…¥æ•°æ®çš„ä¸»é”®ï¼Œç„¶åæ‰§æ•°æ®æ’å…¥æ“ä½œï¼Œè¿è¡Œå¯¹åº”çš„ SQL è¯­å¥ã€‚
- â‘¢ æœåŠ¡ç«¯å°†è¯¥æ¡æ•°æ®æ’å…¥æ•°æ®åº“ä¸­ï¼Œå¦‚æœæ’å…¥æˆåŠŸåˆ™è¡¨ç¤ºæ²¡æœ‰é‡å¤è°ƒç”¨æ¥å£ã€‚å¦‚æœæŠ›å‡ºä¸»é”®é‡å¤å¼‚å¸¸ï¼Œåˆ™è¡¨ç¤ºæ•°æ®åº“ä¸­å·²ç»å­˜åœ¨è¯¥æ¡è®°å½•ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯åˆ°å®¢æˆ·ç«¯ã€‚

## æ–¹æ¡ˆäºŒï¼šæ•°æ®åº“ä¹è§‚é”

**æ–¹æ¡ˆæè¿°ï¼š**

æ•°æ®åº“ä¹è§‚é”æ–¹æ¡ˆä¸€èˆ¬åªèƒ½é€‚ç”¨äºæ‰§è¡Œâ€œæ›´æ–°æ“ä½œâ€çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥æå‰åœ¨å¯¹åº”çš„æ•°æ®è¡¨ä¸­å¤šæ·»åŠ ä¸€ä¸ªå­—æ®µï¼Œå……å½“å½“å‰æ•°æ®çš„ç‰ˆæœ¬æ ‡è¯†ã€‚è¿™æ ·æ¯æ¬¡å¯¹è¯¥æ•°æ®åº“è¯¥è¡¨çš„è¿™æ¡æ•°æ®æ‰§è¡Œæ›´æ–°æ—¶ï¼Œéƒ½ä¼šå°†è¯¥ç‰ˆæœ¬æ ‡è¯†ä½œä¸ºä¸€ä¸ªæ¡ä»¶ï¼Œå€¼ä¸ºä¸Šæ¬¡å¾…æ›´æ–°æ•°æ®ä¸­çš„ç‰ˆæœ¬æ ‡è¯†çš„å€¼ã€‚

**é€‚ç”¨æ“ä½œï¼š**

- æ›´æ–°æ“ä½œ

**ä½¿ç”¨é™åˆ¶ï¼š**

- éœ€è¦æ•°æ®åº“å¯¹åº”ä¸šåŠ¡è¡¨ä¸­æ·»åŠ é¢å¤–å­—æ®µï¼›

**æè¿°ç¤ºä¾‹ï¼š**

![å›¾ç‰‡](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

ä¾‹å¦‚ï¼Œå­˜åœ¨å¦‚ä¸‹çš„æ•°æ®è¡¨ä¸­ï¼š

| id   | name     | price |
| :--- | :------- | :---- |
| 1    | å°ç±³æ‰‹æœº | 1000  |
| 2    | è‹¹æœæ‰‹æœº | 2500  |
| 3    | åä¸ºæ‰‹æœº | 1600  |

ä¸ºäº†æ¯æ¬¡æ‰§è¡Œæ›´æ–°æ—¶é˜²æ­¢é‡å¤æ›´æ–°ï¼Œç¡®å®šæ›´æ–°çš„ä¸€å®šæ˜¯è¦æ›´æ–°çš„å†…å®¹ï¼Œæˆ‘ä»¬é€šå¸¸éƒ½ä¼šæ·»åŠ ä¸€ä¸ª version å­—æ®µè®°å½•å½“å‰çš„è®°å½•ç‰ˆæœ¬ï¼Œè¿™æ ·åœ¨æ›´æ–°æ—¶å€™å°†è¯¥å€¼å¸¦ä¸Šï¼Œé‚£ä¹ˆåªè¦æ‰§è¡Œæ›´æ–°æ“ä½œå°±èƒ½ç¡®å®šä¸€å®šæ›´æ–°çš„æ˜¯æŸä¸ªå¯¹åº”ç‰ˆæœ¬ä¸‹çš„ä¿¡æ¯ã€‚

| id   | name     | price | version |
| :--- | :------- | :---- | :------ |
| 1    | å°ç±³æ‰‹æœº | 1000  | 10      |
| 2    | è‹¹æœæ‰‹æœº | 2500  | 21      |
| 3    | åä¸ºæ‰‹æœº | 1600  | 5       |

è¿™æ ·æ¯æ¬¡æ‰§è¡Œæ›´æ–°æ—¶å€™ï¼Œéƒ½è¦æŒ‡å®šè¦æ›´æ–°çš„ç‰ˆæœ¬å·ï¼Œå¦‚ä¸‹æ“ä½œå°±èƒ½å‡†ç¡®æ›´æ–° version=5 çš„ä¿¡æ¯ï¼š

```
UPDATE my_table SET price=price+50,version=version+1 WHERE id=1 AND version=5
```

ä¸Šé¢ WHERE åé¢è·Ÿç€æ¡ä»¶ id=1 AND version=5 è¢«æ‰§è¡Œåï¼Œid=1 çš„ version è¢«æ›´æ–°ä¸º 6ï¼Œæ‰€ä»¥å¦‚æœé‡å¤æ‰§è¡Œè¯¥æ¡ SQL è¯­å¥å°†ä¸ç”Ÿæ•ˆï¼Œå› ä¸º id=1 AND version=5 çš„æ•°æ®å·²ç»ä¸å­˜åœ¨ï¼Œè¿™æ ·å°±èƒ½ä¿ä½æ›´æ–°çš„å¹‚ç­‰ï¼Œå¤šæ¬¡æ›´æ–°å¯¹ç»“æœä¸ä¼šäº§ç”Ÿå½±å“ã€‚

## æ–¹æ¡ˆä¸‰ï¼šé˜²é‡ Token ä»¤ç‰Œ

**æ–¹æ¡ˆæè¿°ï¼š**

é’ˆå¯¹å®¢æˆ·ç«¯è¿ç»­ç‚¹å‡»æˆ–è€…è°ƒç”¨æ–¹çš„è¶…æ—¶é‡è¯•ç­‰æƒ…å†µï¼Œä¾‹å¦‚æäº¤è®¢å•ï¼Œæ­¤ç§æ“ä½œå°±å¯ä»¥ç”¨ Token çš„æœºåˆ¶å®ç°é˜²æ­¢é‡å¤æäº¤ã€‚ç®€å•çš„è¯´å°±æ˜¯è°ƒç”¨æ–¹åœ¨è°ƒç”¨æ¥å£çš„æ—¶å€™å…ˆå‘åç«¯è¯·æ±‚ä¸€ä¸ªå…¨å±€ IDï¼ˆTokenï¼‰ï¼Œè¯·æ±‚çš„æ—¶å€™æºå¸¦è¿™ä¸ªå…¨å±€ ID ä¸€èµ·è¯·æ±‚ï¼ˆToken æœ€å¥½å°†å…¶æ”¾åˆ° Headers ä¸­ï¼‰ï¼Œåç«¯éœ€è¦å¯¹è¿™ä¸ª Token ä½œä¸º Keyï¼Œç”¨æˆ·ä¿¡æ¯ä½œä¸º Value åˆ° Redis ä¸­è¿›è¡Œé”®å€¼å†…å®¹æ ¡éªŒï¼Œå¦‚æœ Key å­˜åœ¨ä¸” Value åŒ¹é…å°±æ‰§è¡Œåˆ é™¤å‘½ä»¤ï¼Œç„¶åæ­£å¸¸æ‰§è¡Œåé¢çš„ä¸šåŠ¡é€»è¾‘ã€‚å¦‚æœä¸å­˜åœ¨å¯¹åº”çš„ Key æˆ– Value ä¸åŒ¹é…å°±è¿”å›é‡å¤æ‰§è¡Œçš„é”™è¯¯ä¿¡æ¯ï¼Œè¿™æ ·æ¥ä¿è¯å¹‚ç­‰æ“ä½œã€‚

**é€‚ç”¨æ“ä½œï¼š**

- æ’å…¥æ“ä½œ
- æ›´æ–°æ“ä½œ
- åˆ é™¤æ“ä½œ

**ä½¿ç”¨é™åˆ¶ï¼š**

- éœ€è¦ç”Ÿæˆå…¨å±€å”¯ä¸€ Token ä¸²ï¼›
- éœ€è¦ä½¿ç”¨ç¬¬ä¸‰æ–¹ç»„ä»¶ Redis è¿›è¡Œæ•°æ®æ•ˆéªŒï¼›

**ä¸»è¦æµç¨‹ï¼š**

![å›¾ç‰‡](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

- â‘  æœåŠ¡ç«¯æä¾›è·å– Token çš„æ¥å£ï¼Œè¯¥ Token å¯ä»¥æ˜¯ä¸€ä¸ªåºåˆ—å·ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ ID æˆ–è€… UUID ä¸²ã€‚
- â‘¡ å®¢æˆ·ç«¯è°ƒç”¨æ¥å£è·å– Tokenï¼Œè¿™æ—¶å€™æœåŠ¡ç«¯ä¼šç”Ÿæˆä¸€ä¸ª Token ä¸²ã€‚
- â‘¢ ç„¶åå°†è¯¥ä¸²å­˜å…¥ Redis æ•°æ®åº“ä¸­ï¼Œä»¥è¯¥ Token ä½œä¸º Redis çš„é”®ï¼ˆæ³¨æ„è®¾ç½®è¿‡æœŸæ—¶é—´ï¼‰ã€‚
- â‘£ å°† Token è¿”å›åˆ°å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯æ‹¿åˆ°ååº”å­˜åˆ°è¡¨å•éšè—åŸŸä¸­ã€‚
- â‘¤ å®¢æˆ·ç«¯åœ¨æ‰§è¡Œæäº¤è¡¨å•æ—¶ï¼ŒæŠŠ Token å­˜å…¥åˆ° Headers ä¸­ï¼Œæ‰§è¡Œä¸šåŠ¡è¯·æ±‚å¸¦ä¸Šè¯¥ Headersã€‚
- â‘¥ æœåŠ¡ç«¯æ¥æ”¶åˆ°è¯·æ±‚åä» Headers ä¸­æ‹¿åˆ° Tokenï¼Œç„¶åæ ¹æ® Token åˆ° Redis ä¸­æŸ¥æ‰¾è¯¥ key æ˜¯å¦å­˜åœ¨ã€‚
- â‘¦ æœåŠ¡ç«¯æ ¹æ® Redis ä¸­æ˜¯å¦å­˜è¯¥ key è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœå­˜åœ¨å°±å°†è¯¥ key åˆ é™¤ï¼Œç„¶åæ­£å¸¸æ‰§è¡Œä¸šåŠ¡é€»è¾‘ã€‚å¦‚æœä¸å­˜åœ¨å°±æŠ›å¼‚å¸¸ï¼Œè¿”å›é‡å¤æäº¤çš„é”™è¯¯ä¿¡æ¯ã€‚

> æ³¨æ„ï¼Œåœ¨å¹¶å‘æƒ…å†µä¸‹ï¼Œæ‰§è¡Œ Redis æŸ¥æ‰¾æ•°æ®ä¸åˆ é™¤éœ€è¦ä¿è¯åŸå­æ€§ï¼Œå¦åˆ™å¾ˆå¯èƒ½åœ¨å¹¶å‘ä¸‹æ— æ³•ä¿è¯å¹‚ç­‰æ€§ã€‚å…¶å®ç°æ–¹æ³•å¯ä»¥ä½¿ç”¨åˆ†å¸ƒå¼é”æˆ–è€…ä½¿ç”¨ Lua è¡¨è¾¾å¼æ¥æ³¨é”€æŸ¥è¯¢ä¸åˆ é™¤æ“ä½œã€‚

## æ–¹æ¡ˆå››ã€ä¸‹æ¸¸ä¼ é€’å”¯ä¸€åºåˆ—å·

**æ–¹æ¡ˆæè¿°ï¼š**

æ‰€è°“è¯·æ±‚åºåˆ—å·ï¼Œå…¶å®å°±æ˜¯æ¯æ¬¡å‘æœåŠ¡ç«¯è¯·æ±‚æ—¶å€™é™„å¸¦ä¸€ä¸ªçŸ­æ—¶é—´å†…å”¯ä¸€ä¸é‡å¤çš„åºåˆ—å·ï¼Œè¯¥åºåˆ—å·å¯ä»¥æ˜¯ä¸€ä¸ªæœ‰åº IDï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªè®¢å•å·ï¼Œä¸€èˆ¬ç”±ä¸‹æ¸¸ç”Ÿæˆï¼Œåœ¨è°ƒç”¨ä¸Šæ¸¸æœåŠ¡ç«¯æ¥å£æ—¶é™„åŠ è¯¥åºåˆ—å·å’Œç”¨äºè®¤è¯çš„ IDã€‚

å½“ä¸Šæ¸¸æœåŠ¡å™¨æ”¶åˆ°è¯·æ±‚ä¿¡æ¯åæ‹¿å–è¯¥ åºåˆ—å· å’Œä¸‹æ¸¸ è®¤è¯ID è¿›è¡Œç»„åˆï¼Œå½¢æˆç”¨äºæ“ä½œ Redis çš„ Keyï¼Œç„¶ååˆ° Redis ä¸­æŸ¥è¯¢æ˜¯å¦å­˜åœ¨å¯¹åº”çš„ Key çš„é”®å€¼å¯¹ï¼Œæ ¹æ®å…¶ç»“æœï¼š

- å¦‚æœå­˜åœ¨ï¼Œå°±è¯´æ˜å·²ç»å¯¹è¯¥ä¸‹æ¸¸çš„è¯¥åºåˆ—å·çš„è¯·æ±‚è¿›è¡Œäº†ä¸šåŠ¡å¤„ç†ï¼Œè¿™æ—¶å¯ä»¥ç›´æ¥å“åº”é‡å¤è¯·æ±‚çš„é”™è¯¯ä¿¡æ¯ã€‚
- å¦‚æœä¸å­˜åœ¨ï¼Œå°±ä»¥è¯¥ Key ä½œä¸º Redis çš„é”®ï¼Œä»¥ä¸‹æ¸¸å…³é”®ä¿¡æ¯ä½œä¸ºå­˜å‚¨çš„å€¼ï¼ˆä¾‹å¦‚ä¸‹æ¸¸å•†ä¼ é€’çš„ä¸€äº›ä¸šåŠ¡é€»è¾‘ä¿¡æ¯ï¼‰ï¼Œå°†è¯¥é”®å€¼å¯¹å­˜å‚¨åˆ° Redis ä¸­ ï¼Œç„¶åå†æ­£å¸¸æ‰§è¡Œå¯¹åº”çš„ä¸šåŠ¡é€»è¾‘å³å¯ã€‚

**é€‚ç”¨æ“ä½œï¼š**

- æ’å…¥æ“ä½œ
- æ›´æ–°æ“ä½œ
- åˆ é™¤æ“ä½œ

**ä½¿ç”¨é™åˆ¶ï¼š**

- è¦æ±‚ç¬¬ä¸‰æ–¹ä¼ é€’å”¯ä¸€åºåˆ—å·ï¼›
- éœ€è¦ä½¿ç”¨ç¬¬ä¸‰æ–¹ç»„ä»¶ Redis è¿›è¡Œæ•°æ®æ•ˆéªŒï¼›

**ä¸»è¦æµç¨‹ï¼š**

![å›¾ç‰‡](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

ä¸»è¦æ­¥éª¤ï¼š

- â‘  ä¸‹æ¸¸æœåŠ¡ç”Ÿæˆåˆ†å¸ƒå¼ ID ä½œä¸ºåºåˆ—å·ï¼Œç„¶åæ‰§è¡Œè¯·æ±‚è°ƒç”¨ä¸Šæ¸¸æ¥å£ï¼Œå¹¶é™„å¸¦â€œå”¯ä¸€åºåˆ—å·â€ä¸è¯·æ±‚çš„â€œè®¤è¯å‡­æ®IDâ€ã€‚
- â‘¡ ä¸Šæ¸¸æœåŠ¡è¿›è¡Œå®‰å…¨æ•ˆéªŒï¼Œæ£€æµ‹ä¸‹æ¸¸ä¼ é€’çš„å‚æ•°ä¸­æ˜¯å¦å­˜åœ¨â€œåºåˆ—å·â€å’Œâ€œå‡­æ®IDâ€ã€‚
- â‘¢ ä¸Šæ¸¸æœåŠ¡åˆ° Redis ä¸­æ£€æµ‹æ˜¯å¦å­˜åœ¨å¯¹åº”çš„â€œåºåˆ—å·â€ä¸â€œè®¤è¯IDâ€ç»„æˆçš„ Keyï¼Œå¦‚æœå­˜åœ¨å°±æŠ›å‡ºé‡å¤æ‰§è¡Œçš„å¼‚å¸¸ä¿¡æ¯ï¼Œç„¶åå“åº”ä¸‹æ¸¸å¯¹åº”çš„é”™è¯¯ä¿¡æ¯ã€‚å¦‚æœä¸å­˜åœ¨å°±ä»¥è¯¥â€œåºåˆ—å·â€å’Œâ€œè®¤è¯IDâ€ç»„åˆä½œä¸º Keyï¼Œä»¥ä¸‹æ¸¸å…³é”®ä¿¡æ¯ä½œä¸º Valueï¼Œè¿›è€Œå­˜å‚¨åˆ° Redis ä¸­ï¼Œç„¶åæ­£å¸¸æ‰§è¡Œæ¥æ¥æ¥çš„ä¸šåŠ¡é€»è¾‘ã€‚

> ä¸Šé¢æ­¥éª¤ä¸­æ’å…¥æ•°æ®åˆ° Redis ä¸€å®šè¦è®¾ç½®è¿‡æœŸæ—¶é—´ã€‚è¿™æ ·èƒ½ä¿è¯åœ¨è¿™ä¸ªæ—¶é—´èŒƒå›´å†…ï¼Œå¦‚æœé‡å¤è°ƒç”¨æ¥å£ï¼Œåˆ™èƒ½å¤Ÿè¿›è¡Œåˆ¤æ–­è¯†åˆ«ã€‚å¦‚æœä¸è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œå¾ˆå¯èƒ½å¯¼è‡´æ•°æ®æ— é™é‡çš„å­˜å…¥ Redisï¼Œè‡´ä½¿ Redis ä¸èƒ½æ­£å¸¸å·¥ä½œã€‚

# ä¸ƒã€å®ç°æ¥å£å¹‚ç­‰ç¤ºä¾‹

è¿™é‡Œä½¿ç”¨é˜²é‡ Token ä»¤ç‰Œæ–¹æ¡ˆï¼Œè¯¥æ–¹æ¡ˆèƒ½ä¿è¯åœ¨ä¸åŒè¯·æ±‚åŠ¨ä½œä¸‹çš„å¹‚ç­‰æ€§ï¼Œå®ç°é€»è¾‘å¯ä»¥çœ‹ä¸Šé¢å†™çš„â€é˜²é‡ Token ä»¤ç‰Œâ€æ–¹æ¡ˆï¼Œæ¥ä¸‹æ¥å†™ä¸‹å®ç°è¿™ä¸ªé€»è¾‘çš„ä»£ç ã€‚

## 1ã€Maven å¼•å…¥ç›¸å…³ä¾èµ–

è¿™é‡Œä½¿ç”¨ Maven å·¥å…·ç®¡ç†ä¾èµ–ï¼Œè¿™é‡Œåœ¨ pom.xml ä¸­å¼•å…¥ SpringBootã€Redisã€lombok ç›¸å…³ä¾èµ–ã€‚

```
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>2.3.4.RELEASE</version>
    </parent>

    <groupId>mydlq.club</groupId>
    <artifactId>springboot-idempotent-token</artifactId>
    <version>0.0.1</version>
    <name>springboot-idempotent-token</name>
    <description>Idempotent Demo</description>

    <properties>
        <java.version>1.8</java.version>
    </properties>

    <dependencies>
        <!--springboot web-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <!--springboot data redis-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-redis</artifactId>
        </dependency>
        <dependency>
            <groupId>org.apache.commons</groupId>
            <artifactId>commons-pool2</artifactId>
        </dependency>
        <!--lombok-->
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
        </dependency>
    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
            </plugin>
        </plugins>
    </build>

</project>
```

## 2ã€é…ç½®è¿æ¥ Redis çš„å‚æ•°

åœ¨ application é…ç½®æ–‡ä»¶ä¸­é…ç½®è¿æ¥ Redis çš„å‚æ•°ï¼Œå¦‚ä¸‹ï¼š

```
spring:
  redis:
    ssl: false
    host: 127.0.0.1
    port: 6379
    database: 0
    timeout: 1000
    password:
    lettuce:
      pool:
        max-active: 100
        max-wait: -1
        min-idle: 0
        max-idle: 20
```

## 3ã€åˆ›å»ºä¸éªŒè¯ Token å·¥å…·ç±»

åˆ›å»ºç”¨äºæ“ä½œ Token ç›¸å…³çš„ Service ç±»ï¼Œé‡Œé¢å­˜åœ¨ Token åˆ›å»ºä¸éªŒè¯æ–¹æ³•ï¼Œå…¶ä¸­ï¼š

- **Token åˆ›å»ºæ–¹æ³•ï¼š** ä½¿ç”¨ UUID å·¥å…·åˆ›å»º Token ä¸²ï¼Œè®¾ç½®ä»¥ â€œidempotent_token:â€œ+â€œTokenä¸²â€ ä½œä¸º Keyï¼Œä»¥ç”¨æˆ·ä¿¡æ¯å½“æˆ Valueï¼Œå°†ä¿¡æ¯å­˜å…¥ Redis ä¸­ã€‚
- **Token éªŒè¯æ–¹æ³•ï¼š** æ¥æ”¶ Token ä¸²å‚æ•°ï¼ŒåŠ ä¸Š Key å‰ç¼€å½¢æˆ Keyï¼Œå†ä¼ å…¥ value å€¼ï¼Œæ‰§è¡Œ Lua è¡¨è¾¾å¼ï¼ˆLua è¡¨è¾¾å¼èƒ½ä¿è¯å‘½ä»¤æ‰§è¡Œçš„åŸå­æ€§ï¼‰è¿›è¡ŒæŸ¥æ‰¾å¯¹åº” Key ä¸åˆ é™¤æ“ä½œã€‚æ‰§è¡Œå®ŒæˆåéªŒè¯å‘½ä»¤çš„è¿”å›ç»“æœï¼Œå¦‚æœç»“æœä¸ä¸ºç©ºä¸”é0ï¼Œåˆ™éªŒè¯æˆåŠŸï¼Œå¦åˆ™å¤±è´¥ã€‚

```
import java.util.Arrays;
import java.util.UUID;
import java.util.concurrent.TimeUnit;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.redis.core.StringRedisTemplate;
import org.springframework.data.redis.core.script.DefaultRedisScript;
import org.springframework.data.redis.core.script.RedisScript;
import org.springframework.stereotype.Service;

@Slf4j
@Service
public class TokenUtilService {

    @Autowired
    private StringRedisTemplate redisTemplate;

    /**
     * å­˜å…¥ Redis çš„ Token é”®çš„å‰ç¼€
     */
    private static final String IDEMPOTENT_TOKEN_PREFIX = "idempotent_token:";

    /**
     * åˆ›å»º Token å­˜å…¥ Redisï¼Œå¹¶è¿”å›è¯¥ Token
     *
     * @param value ç”¨äºè¾…åŠ©éªŒè¯çš„ value å€¼
     * @return ç”Ÿæˆçš„ Token ä¸²
     */
    public String generateToken(String value) {
        // å®ä¾‹åŒ–ç”Ÿæˆ ID å·¥å…·å¯¹è±¡
        String token = UUID.randomUUID().toString();
        // è®¾ç½®å­˜å…¥ Redis çš„ Key
        String key = IDEMPOTENT_TOKEN_PREFIX + token;
        // å­˜å‚¨ Token åˆ° Redisï¼Œä¸”è®¾ç½®è¿‡æœŸæ—¶é—´ä¸º5åˆ†é’Ÿ
        redisTemplate.opsForValue().set(key, value, 5, TimeUnit.MINUTES);
        // è¿”å› Token
        return token;
    }

    /**
     * éªŒè¯ Token æ­£ç¡®æ€§
     *
     * @param token token å­—ç¬¦ä¸²
     * @param value value å­˜å‚¨åœ¨Redisä¸­çš„è¾…åŠ©éªŒè¯ä¿¡æ¯
     * @return éªŒè¯ç»“æœ
     */
    public boolean validToken(String token, String value) {
        // è®¾ç½® Lua è„šæœ¬ï¼Œå…¶ä¸­ KEYS[1] æ˜¯ keyï¼ŒKEYS[2] æ˜¯ value
        String script = "if redis.call('get', KEYS[1]) == KEYS[2] then return redis.call('del', KEYS[1]) else return 0 end";
        RedisScript<Long> redisScript = new DefaultRedisScript<>(script, Long.class);
        // æ ¹æ® Key å‰ç¼€æ‹¼æ¥ Key
        String key = IDEMPOTENT_TOKEN_PREFIX + token;
        // æ‰§è¡Œ Lua è„šæœ¬
        Long result = redisTemplate.execute(redisScript, Arrays.asList(key, value));
        // æ ¹æ®è¿”å›ç»“æœåˆ¤æ–­æ˜¯å¦æˆåŠŸæˆåŠŸåŒ¹é…å¹¶åˆ é™¤ Redis é”®å€¼å¯¹ï¼Œè‹¥æœç»“æœä¸ä¸ºç©ºå’Œ0ï¼Œåˆ™éªŒè¯é€šè¿‡
        if (result != null && result != 0L) {
            log.info("éªŒè¯ token={},key={},value={} æˆåŠŸ", token, key, value);
            return true;
        }
        log.info("éªŒè¯ token={},key={},value={} å¤±è´¥", token, key, value);
        return false;
    }

}
```

## 4ã€åˆ›å»ºæµ‹è¯•çš„ Controller ç±»

åˆ›å»ºç”¨äºæµ‹è¯•çš„ Controller ç±»ï¼Œé‡Œé¢æœ‰è·å– Token ä¸æµ‹è¯•æ¥å£å¹‚ç­‰æ€§çš„æ¥å£ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```
import lombok.extern.slf4j.Slf4j;
import mydlq.club.example.service.TokenUtilService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

@Slf4j
@RestController
public class TokenController {

    @Autowired
    private TokenUtilService tokenService;

    /**
     * è·å– Token æ¥å£
     *
     * @return Token ä¸²
     */
    @GetMapping("/token")
    public String getToken() {
        // è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆè¿™é‡Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼‰
        // æ³¨ï¼šè¿™é‡Œå­˜å‚¨è¯¥å†…å®¹åªæ˜¯ä¸¾ä¾‹ï¼Œå…¶ä½œç”¨ä¸ºè¾…åŠ©éªŒè¯ï¼Œä½¿å…¶éªŒè¯é€»è¾‘æ›´å®‰å…¨ï¼Œå¦‚è¿™é‡Œå­˜å‚¨ç”¨æˆ·ä¿¡æ¯ï¼Œå…¶ç›®çš„ä¸º:
        // - 1)ã€ä½¿ç”¨"token"éªŒè¯ Redis ä¸­æ˜¯å¦å­˜åœ¨å¯¹åº”çš„ Key
        // - 2)ã€ä½¿ç”¨"ç”¨æˆ·ä¿¡æ¯"éªŒè¯ Redis çš„ Value æ˜¯å¦åŒ¹é…ã€‚
        String userInfo = "mydlq";
        // è·å– Token å­—ç¬¦ä¸²ï¼Œå¹¶è¿”å›
        return tokenService.generateToken(userInfo);
    }

    /**
     * æ¥å£å¹‚ç­‰æ€§æµ‹è¯•æ¥å£
     *
     * @param token å¹‚ç­‰ Token ä¸²
     * @return æ‰§è¡Œç»“æœ
     */
    @PostMapping("/test")
    public String test(@RequestHeader(value = "token") String token) {
        // è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆè¿™é‡Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼‰
        String userInfo = "mydlq";
        // æ ¹æ® Token å’Œä¸ç”¨æˆ·ç›¸å…³çš„ä¿¡æ¯åˆ° Redis éªŒè¯æ˜¯å¦å­˜åœ¨å¯¹åº”çš„ä¿¡æ¯
        boolean result = tokenService.validToken(token, userInfo);
        // æ ¹æ®éªŒè¯ç»“æœå“åº”ä¸åŒä¿¡æ¯
        return result ? "æ­£å¸¸è°ƒç”¨" : "é‡å¤è°ƒç”¨";
    }

}
```

## 5ã€åˆ›å»º SpringBoot å¯åŠ¨ç±»

åˆ›å»ºå¯åŠ¨ç±»ï¼Œç”¨äºå¯åŠ¨ SpringBoot åº”ç”¨ã€‚

```
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class Application {

    public static void main(String[] args) {
        SpringApplication.run(Application.class, args);
    }

}
```

## 6ã€å†™æµ‹è¯•ç±»è¿›è¡Œæµ‹è¯•

å†™ä¸ªæµ‹è¯•ç±»è¿›è¡Œæµ‹è¯•ï¼Œå¤šæ¬¡è®¿é—®åŒä¸€ä¸ªæ¥å£ï¼Œæµ‹è¯•æ˜¯å¦åªæœ‰ç¬¬ä¸€æ¬¡èƒ½å¦æ‰§è¡ŒæˆåŠŸã€‚

```
import org.junit.Assert;
import org.junit.Test;
import org.junit.runner.RunWith;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.http.MediaType;
import org.springframework.test.context.junit4.SpringRunner;
import org.springframework.test.web.servlet.MockMvc;
import org.springframework.test.web.servlet.request.MockMvcRequestBuilders;
import org.springframework.test.web.servlet.setup.MockMvcBuilders;
import org.springframework.web.context.WebApplicationContext;

@Slf4j
@SpringBootTest
@RunWith(SpringRunner.class)
public class IdempotenceTest {

    @Autowired
    private WebApplicationContext webApplicationContext;

    @Test
    public void interfaceIdempotenceTest() throws Exception {
        // åˆå§‹åŒ– MockMvc
        MockMvc mockMvc = MockMvcBuilders.webAppContextSetup(webApplicationContext).build();
        // è°ƒç”¨è·å– Token æ¥å£
        String token = mockMvc.perform(MockMvcRequestBuilders.get("/token")
                .accept(MediaType.TEXT_HTML))
                .andReturn()
                .getResponse().getContentAsString();
        log.info("è·å–çš„ Token ä¸²ï¼š{}", token);
        // å¾ªç¯è°ƒç”¨ 5 æ¬¡è¿›è¡Œæµ‹è¯•
        for (int i = 1; i <= 5; i++) {
            log.info("ç¬¬{}æ¬¡è°ƒç”¨æµ‹è¯•æ¥å£", i);
            // è°ƒç”¨éªŒè¯æ¥å£å¹¶æ‰“å°ç»“æœ
            String result = mockMvc.perform(MockMvcRequestBuilders.post("/test")
                    .header("token", token)
                    .accept(MediaType.TEXT_HTML))
                    .andReturn().getResponse().getContentAsString();
            log.info(result);
            // ç»“æœæ–­è¨€
            if (i == 0) {
                Assert.assertEquals(result, "æ­£å¸¸è°ƒç”¨");
            } else {
                Assert.assertEquals(result, "é‡å¤è°ƒç”¨");
            }
        }
    }

}
```

æ˜¾ç¤ºå¦‚ä¸‹ï¼š

```
[main] IdempotenceTest:  è·å–çš„ Token ä¸²ï¼š980ea707-ce2e-456e-a059-0a03332110b4
[main] IdempotenceTest:  ç¬¬1æ¬¡è°ƒç”¨æµ‹è¯•æ¥å£
[main] IdempotenceTest:  æ­£å¸¸è°ƒç”¨
[main] IdempotenceTest:  ç¬¬2æ¬¡è°ƒç”¨æµ‹è¯•æ¥å£
[main] IdempotenceTest:  é‡å¤è°ƒç”¨
[main] IdempotenceTest:  ç¬¬3æ¬¡è°ƒç”¨æµ‹è¯•æ¥å£
[main] IdempotenceTest:  é‡å¤è°ƒç”¨
[main] IdempotenceTest:  ç¬¬4æ¬¡è°ƒç”¨æµ‹è¯•æ¥å£
[main] IdempotenceTest:  é‡å¤è°ƒç”¨
[main] IdempotenceTest:  ç¬¬5æ¬¡è°ƒç”¨æµ‹è¯•æ¥å£
[main] IdempotenceTest:  é‡å¤è°ƒç”¨
```

# å…«ã€æœ€åæ€»ç»“

å¹‚ç­‰æ€§æ˜¯å¼€å‘å½“ä¸­å¾ˆå¸¸è§ä¹Ÿå¾ˆé‡è¦çš„ä¸€ä¸ªéœ€æ±‚ï¼Œå°¤å…¶æ˜¯æ”¯ä»˜ã€è®¢å•ç­‰ä¸é‡‘é’±æŒ‚é’©çš„æœåŠ¡ï¼Œä¿è¯æ¥å£å¹‚ç­‰æ€§å°¤å…¶é‡è¦ã€‚åœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬éœ€è¦é’ˆå¯¹ä¸åŒçš„ä¸šåŠ¡åœºæ™¯æˆ‘ä»¬éœ€è¦çµæ´»çš„é€‰æ‹©å¹‚ç­‰æ€§çš„å®ç°æ–¹å¼ï¼š

- å¯¹äºä¸‹å•ç­‰å­˜åœ¨å”¯ä¸€ä¸»é”®çš„ï¼Œå¯ä»¥ä½¿ç”¨â€œå”¯ä¸€ä¸»é”®æ–¹æ¡ˆâ€çš„æ–¹å¼å®ç°ã€‚
- å¯¹äºæ›´æ–°è®¢å•çŠ¶æ€ç­‰ç›¸å…³çš„æ›´æ–°åœºæ™¯æ“ä½œï¼Œä½¿ç”¨â€œä¹è§‚é”æ–¹æ¡ˆâ€å®ç°æ›´ä¸ºç®€å•ã€‚
- å¯¹äºä¸Šä¸‹æ¸¸è¿™ç§ï¼Œä¸‹æ¸¸è¯·æ±‚ä¸Šæ¸¸ï¼Œä¸Šæ¸¸æœåŠ¡å¯ä»¥ä½¿ç”¨â€œä¸‹æ¸¸ä¼ é€’å”¯ä¸€åºåˆ—å·æ–¹æ¡ˆâ€æ›´ä¸ºåˆç†ã€‚
- ç±»ä¼¼äºå‰ç«¯é‡å¤æäº¤ã€é‡å¤ä¸‹å•ã€æ²¡æœ‰å”¯ä¸€IDå·çš„åœºæ™¯ï¼Œå¯ä»¥é€šè¿‡ Token ä¸ Redis é…åˆçš„â€œé˜²é‡ Token æ–¹æ¡ˆâ€å®ç°æ›´ä¸ºå¿«æ·ã€‚

ä¸Šé¢åªæ˜¯ç»™ä¸ä¸€äº›å»ºè®®ï¼Œå†æ¬¡å¼ºè°ƒä¸€ä¸‹ï¼Œå®ç°å¹‚ç­‰æ€§éœ€è¦å…ˆç†è§£è‡ªèº«ä¸šåŠ¡éœ€æ±‚ï¼Œæ ¹æ®ä¸šåŠ¡é€»è¾‘æ¥å®ç°è¿™æ ·æ‰åˆç†ï¼Œå¤„ç†å¥½å…¶ä¸­çš„æ¯ä¸€ä¸ªç»“ç‚¹ç»†èŠ‚ï¼Œå®Œå–„æ•´ä½“çš„ä¸šåŠ¡æµç¨‹è®¾è®¡ï¼Œæ‰èƒ½æ›´å¥½çš„ä¿è¯ç³»ç»Ÿçš„æ­£å¸¸è¿è¡Œã€‚æœ€ååšä¸€ä¸ªç®€å•æ€»ç»“ï¼Œç„¶åæœ¬åšæ–‡åˆ°æ­¤ç»“æŸï¼Œå¦‚ä¸‹ï¼š

| æ–¹æ¡ˆåç§°        | é€‚ç”¨æ–¹æ³•                   | å®ç°å¤æ‚åº¦ | æ–¹æ¡ˆç¼ºç‚¹                                                     |
| :-------------- | :------------------------- | :--------- | :----------------------------------------------------------- |
| æ•°æ®åº“å”¯ä¸€ä¸»é”®  | æ’å…¥æ“ä½œ åˆ é™¤æ“ä½œ          | ç®€å•       | - åªèƒ½ç”¨äºæ’å…¥æ“ä½œï¼›- åªèƒ½ç”¨äºå­˜åœ¨å”¯ä¸€ä¸»é”®åœºæ™¯ï¼›             |
| æ•°æ®åº“ä¹è§‚é”    | æ›´æ–°æ“ä½œ                   | ç®€å•       | - åªèƒ½ç”¨äºæ›´æ–°æ“ä½œï¼›- è¡¨ä¸­éœ€è¦é¢å¤–æ·»åŠ å­—æ®µï¼›                 |
| è¯·æ±‚åºåˆ—å·      | æ’å…¥æ“ä½œ æ›´æ–°æ“ä½œ åˆ é™¤æ“ä½œ | ç®€å•       | - éœ€è¦ä¿è¯ä¸‹æ¸¸ç”Ÿæˆå”¯ä¸€åºåˆ—å·ï¼›- éœ€è¦ Redis ç¬¬ä¸‰æ–¹å­˜å‚¨å·²ç»è¯·æ±‚çš„åºåˆ—å·ï¼› |
| é˜²é‡ Token ä»¤ç‰Œ | æ’å…¥æ“ä½œ æ›´æ–°æ“ä½œ åˆ é™¤æ“ä½œ | é€‚ä¸­       | - éœ€è¦ Redis ç¬¬ä¸‰æ–¹å­˜å‚¨ç”Ÿæˆçš„ Token ä¸²ï¼›                     |



------

------

## è¿‘æœŸçƒ­æ–‡

#### `â€¢ å¦‚ä½•ä¼˜é›…çš„ç»Ÿè®¡ä»£ç è€—æ—¶ï¼Œå¿«é€ŸçŸ¥é“ä½ çš„ç¨‹åºæ…¢åœ¨å“ªé‡Œï¼â€¢ æ‹¥æŠ± Java 8 å¹¶è¡Œæµï¼šæ‰§è¡Œé€Ÿåº¦é£èµ· ï¼â€¢ BeanUtils æ˜¯ç”¨ Spring çš„è¿˜æ˜¯ Apache çš„å¥½ï¼Ÿâ€¢ ç”µå•†ç³»ç»Ÿä¸­APIæ¥å£é˜²æ­¢å‚æ•°ç¯¡æ”¹å’Œé‡æ”¾æ”»å‡»ï¼ˆå°ç¨‹åº/APPï¼‰â€¢ Redisé¢è¯•çªå‡»ä¸“ç”¨â€¢ åˆ†äº« 5 ä¸ªå…è´¹çš„åœ¨çº¿ SQL æ•°æ®åº“ç¯å¢ƒâ€¢ 10 ä¸ªæœ€å¥½ç”¨çš„é‡æ„å°æŠ€å·§`

![å†™ä»£ç çš„æ¸£æ¸£é¹](http://mmbiz.qpic.cn/mmbiz_png/Kp4CFraY7DjqmY12sz2MDPOyJwgtWxCyxXyd7bJLkHQZAee6dgZ4vsKlzU3ib4icg6xpYFOpcibjZIWrj52ABEUibg/0?wx_fmt=png)

**å†™ä»£ç çš„æ¸£æ¸£é¹**

å…³æ³¨æˆ‘ï¼Œå­¦å¥½Java.è®©Spring Boot, å¾®æœåŠ¡,é«˜å¹¶å‘ï¼ŒåŒ…æ‹¬å¤šçº¿ç¨‹ã€JVMã€Spring Cloudä¸å†æœ‰éš¾é¢˜ï¼Œè®©javaä¸å†éš¾æ‡‚ã€‚

43ç¯‡åŸåˆ›å†…å®¹



å…¬ä¼—å·

é˜…è¯» 869

åˆ†äº«æ”¶è—

èµ4åœ¨çœ‹4

åˆ†äº«æ­¤å†…å®¹çš„äººè¿˜å–œæ¬¢

[é˜¿é‡Œæœˆè–ª50kæ‹›ç¨‹åºå‘˜ï¼Œæ‹›è˜è¦æ±‚è®©äººçª’æ¯ï¼é˜¿é‡Œæœˆè–ª50kæ‹›ç¨‹åºå‘˜ï¼Œæ‹›è˜è¦æ±‚è®©äººçª’æ¯ï¼...é˜…è¯» 325å†™ä»£ç çš„æ¸£æ¸£é¹ä¸å–œæ¬¢ä¸çœ‹çš„åŸå› ç¡®å®šå†…å®¹è´¨é‡ä½ ä¸çœ‹æ­¤å…¬ä¼—å·](javascript:void(0);)

å†™ä¸‹ä½ çš„ç•™è¨€